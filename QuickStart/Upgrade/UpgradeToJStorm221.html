<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>JStorm Documentation : Upgrade JStorm2.1.1 To JStorm2.2.1</title>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="icon" href="/img/favicon.png" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/jstorm.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!--




-->
    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="/"><img alt="jstorm" src="/img/jstorm-logo.png"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            
            <!-- Downloads -->
            <li class="hidden-sm "><a href="/Downloads.html">Downloads</a></li>

            <!-- Performance -->
            <li class="hidden-sm "><a href="/Performance">Performance</a></li>

            <!-- QuickStart -->
            <li class="dropdown active">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">QuickStart <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/QuickStart/BasicConception.html">Basic Conception</a></li>
                
                <li class=""><a href="/QuickStart/Example.html">Example</a></li>
                
                <li class=""><a href="/QuickStart/Deploy/index.html">Deploy</a></li>
                
                <li class=""><a href="/QuickStart/Upgrade/index.html">Upgrade</a></li>
                
                <li class=""><a href="/QuickStart/UpgradeFromStorm.html">Migrate from Apache Storm</a></li>
                
                <li class=""><a href="/QuickStart/Compile.html">Compile JStorm</a></li>
                
              </ul>
            </li>

            <!-- ProgrammingGuide -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">ProgrammingGuide <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/ProgrammingGuide/DebugLocalApp.html">Local Debug</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/StreamSplitJoin.html">Split-Merge-Stream</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/Transaction.html">Transaction</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/Trident.html">Trident</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/AdvancedUsage/index.html">Advanced Usage</a></li>
                  
              </ul>
            </li>

            <!-- Maintenance -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Maintenance <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Maintenance/Configuration.html">Configuration</a></li>
                  
                  <li class=""><a href="/Maintenance/ConfigurationAutomacticSync.html">Automatically Sync Configuration</a></li>
                  
                  <li class=""><a href="/Maintenance/Isolation.html">Resource Isolation</a></li>
                  
                  <li class=""><a href="/Maintenance/JStormMetrics.html">JStorm Metrics</a></li>
                  
                  <li class=""><a href="/Maintenance/HealthCheck.html">Supervisor Health Check</a></li>
                  
                  <li class=""><a href="/Maintenance/JStorm-on-Yarn.html">JStorm-on-Yarn</a></li>
                  
                  <li class=""><a href="/Maintenance/ClusterHA.html">Cluster HA</a></li>
                  
                  <li class=""><a href="/Maintenance/SupervisorWorker.html">Supervisor-Generate-Workers</a></li>
                  
                  <li class=""><a href="/Maintenance/DynamicAdjustLog.html">Dynamic Adjust Log</a></li>
                  
              </ul>
            </li>

            <!-- FAQ -->
            <li class="hidden-sm "><a href="/FAQ/">FAQ</a></li>

            <!-- Community -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Community <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Community/Email.html">Email List</a></li>
                  
                  <li class=""><a href="/Community/Committers.html">Committer List</a></li>
                  
                  <li class=""><a href="/Community/Events-Meetups.html">Events and Meetups</a></li>
                  
                  <li class=""><a href="/Community/Issues.html">Track issues</a></li>
                  
                  <li class=""><a href="/Community/JStormUsers.html">JStorm User List</a></li>
                  
              </ul>
            </li>


          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Language <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li class=""><a href="/index.html">English</a></li>
                  <li class=""><a href="/index_cn.html">中文</a></li>

              </ul>
            </li>
          </ul>          
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<div class="row">


  <!-- Sub Navigation -->
  <div class="col-sm-3">
    <ul id="sub-nav">
      
      
      
        
        
        
        <li><a href="/QuickStart/Upgrade/index.html" class="">Upgrade</a>
          
        </li>
      
        
        
        
        <li><a href="/QuickStart/Upgrade/UpgradeApplication.html" class="">Upgrade JStorm0.9.x To JStorm2.1.1</a>
          
        </li>
      
        
        
        
        <li><a href="/QuickStart/Upgrade/UpgradeCluster.html" class="">Upgrade Cluster</a>
          
        </li>
      
        
        
        
        <li><a href="/QuickStart/Upgrade/UpgradeToJStorm221.html" class="active">Upgrade JStorm2.1.1 To JStorm2.2.1</a>
          
        </li>
      
    </ul>
  </div>
  <!-- Main -->
  <div class="col-sm-9">
    <!-- Top anchor -->
    <a href="#top"></a>

    <div class="text">
      <!-- Main heading -->
      <h1>Upgrade JStorm2.1.1 To JStorm2.2.1</h1>

      <!-- Content -->
      <p>This article is a guide on how to upgrade from JStorm 2.1.1 to JStorm 2.2.1.</p>

<h2 id="upgrade-cluster">Upgrade Cluster</h2>

<p>Please refer to <code>Upgrade Cluster</code> document, besides, there’re a few new features that need to take care of.</p>

<h3 id="cluster-config-sync">Cluster Config Sync</h3>

<p>This is a new feature in JStorm 2.2.1. Supervisors will sync the latest storm.yaml from nimbus automatically.
So if you want to change storm.yaml for the whole cluster, just edit storm.yaml in nimbus master, save it,
the new config will be synced to supervisors.</p>

<p>However, if you want something special for each supervisor, you need to add a config: <code>jstorm.yarn.conf.blacklist</code>.</p>

<pre><code>jstorm.yarn.conf.blacklist: "jstorm.log.dir, jstorm.home"
</code></pre>

<p>Still, there’s a known issue, for complex data types, e.g., supervisor port list:</p>

<pre><code>supervisor.slots.ports:
    -6800
    -6801
</code></pre>

<p>For complex data types like list or map, you need to convert the value to standard yaml, in the above case, change 
port list value to:</p>

<pre><code>supervisor.slots.ports: [6800,6801]
</code></pre>

<p>Meanwhile, you can customize your own <code>nimbus.config.update.handler.class</code>, which implements <code>ConfigUpdateHandler</code> 
interface, then you can change your cluster config in other ways, e.g., an external config center.</p>

<p>Still, please note that, cluster config sync doesn’t mean the new config will take effect automatically.
 You still need to restart nimbus and supervisor, currently.</p>

<h3 id="external-modules">External Modules</h3>

<p>Starting from 2.2.1, nimbus and supervisor support external modules.
e.g., you’ve developed an implementation of metric uploader and plan to plugin it to nimbus, then you’ll need to 
follow below steps:</p>

<ol>
  <li>
    <p>code and package your plugin jar (possibly with a bunch of dependency jars)</p>
  </li>
  <li>
    <p>create dir: {jstorm.home}/lib/ext, cd ext and create a sub dir: metric_plugin</p>
  </li>
  <li>
    <p>copy your jar and dependencies into metric_plugin。</p>
  </li>
  <li>
    <p>change storm.yaml, add config: <code>nimbus.external: metric_plugin</code></p>
  </li>
  <li>
    <p>restart nimbus, after that, nimbus will add metric_plugin/* to its classpath, then you can access 
your plugin classes and its features.</p>
  </li>
</ol>

<p>Supervisor supports external modules as well, please use <code>supervisor.external</code> config.</p>

<h2 id="code-changes">Code Changes</h2>

<p>Upgrading from 2.1.1 to 2.2.1 is mostly compatible on application level, just a few minor nits.</p>

<p>a. change jstorm-core pom dependency:</p>

<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.jstorm&lt;/groupId&gt;
    &lt;artifactId&gt;jstorm-core&lt;/artifactId&gt;
    &lt;version&gt;2.2.1&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre>

<p>c. re-compile. you may encounter errors in this step. e.g., if you use user defined metrics, there might be a few 
  package rename, in this case, just remove the original imports and re-import.</p>

<p>d. this step is <strong>very important</strong>, starting from jstorm 2.2.1, jstorm-core has shaded some dependencies which may 
cause problems like snakeyaml，curator-framework, etc.
So if your application depends on snakeyaml to parse yaml, or uses curator framework, you need to add these
  dependencies yourself, otherwise you may encounter errors like “ClassNotFoundError”.</p>

<h2 id="about-serialization">About serialization</h2>

<p>Starting from 2.2.1, jstorm enables kryo by default, which requires no-arg constructor for objects.</p>

<p>IMPORTANT NOTICE(3 times):</p>

<pre><code>objects with no-arg constructor
objects with no-arg constructor
objects with no-arg constructor
</code></pre>

<p>Otherwise you may get error like:</p>

<pre><code>Exception in thread "main" com.esotericsoftware.kryo.KryoException: Class cannot be created (missing no-arg constructor): java.util.List

</code></pre>

<p>If, unfortunately, you can’t make a no-arg constructor for your objects, say, the objects are in your dependencies, 
there’re 2 ways to fix:</p>

<h3 id="disable-kryo">disable kryo</h3>

<p>by adding config to your topology conf to disable kryo:</p>

<pre><code>topology.fall.back.on.java.serialization: true
</code></pre>

<p>you can fall back to java serialization.</p>

<h3 id="create-a-custom-serializer">create a custom serializer</h3>

<p>If performance is a crucial concern, you may not want java serialization, thus custom 
serializer opts in.</p>

<p>For details, please refer to <code>PairSerializer</code> class within sequence-split-merge example in source code.</p>

<p>For example, ByteBuffer, doesn’t have a no-arg constructor, and it’s an abstract class, but we want a serializer for 
<code>HeapByteBuffer</code> class, that’s how we do:</p>

<pre><code class="language-java">public class KryoByteBufferSerializer extends Serializer&lt;ByteBuffer&gt; {

    @Override
    public void write(Kryo kryo, Output output, ByteBuffer object) {
        output.writeInt(object.array().length);
        output.write(object.array());
    }

    @Override
    public ByteBuffer read(Kryo kryo, Input input, Class&lt;ByteBuffer&gt; type) {
        int len = input.readInt();
        return ByteBuffer.wrap(input.readBytes(len));
    }
}
</code></pre>

<p>After that, register the serializer to kryo:</p>

<pre><code>Config.registerSerialization(stormConf, "java.nio.HeapByteBuffer", KryoByteBufferSerializer.class);
</code></pre>

<h2 id="logging-systems">Logging Systems</h2>

<p>Please refer to the doc on upgrading JStorm 0.9.x to JStorm 2.1.1</p>

<h2 id="about-classloader">About Classloader</h2>

<p>In earlier versions, if we have dependency conflicts that can’t be resolved, we need to enable classloader.
However, as mentioned above, JStorm 2.2.1 has shaded some dependencies, in most cases, classloader will not be
necessary and it’s recommended, if, you have enabled classloader before, turn it off.</p>

  
      <div class="footer">
      Google Groups: <a target="_blank" href="https://groups.google.com/forum/#!forum/jstorm-user">jstorm-user</a>, QQ Groups: 228374502
      </p>
      Caught a mistake or want to contribute to the documentation? 
      <a href="https://github.com/alibaba/jstorm/edit/master/docs/jstorm-doc/QuickStart/Upgrade/UpgradeToJStorm221.md" target="_blank">
        Edit this page on Github!
      </a>
  </div>    
    </div>
  </div>

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/js/jstorm.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    <!--
     -->
  </body>
</html>
