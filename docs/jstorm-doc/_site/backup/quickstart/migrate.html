<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>JStorm Documentation : Migrate from JStorm 0.9.x to 2.x</title>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="icon" href="/img/favicon.png" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/jstorm.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!--




-->
    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="/"><img alt="jstorm" src="/img/jstorm-logo.png"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <!-- Example -->
            <li class="hidden-sm "><a href="/Example/">Example</a></li>

            <!-- Downloads -->
            <li class="hidden-sm "><a href="/Downloads/">Downloads</a></li>

            <!-- Performance -->
            <li class="hidden-sm "><a href="/Performance">Performance</a></li>

            <!-- QuickStart -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">QuickStart <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/QuickStart/BasicConception.html">Basic Conception</a></li>
                
                <li class=""><a href="/QuickStart/Example.html">Example</a></li>
                
                <li class=""><a href="/QuickStart/Deploy/">Deploy</a></li>
                
                <li class=""><a href="/QuickStart_cn/Upgrade/">Upgrade</a></li>
                
                <li class=""><a href="/QuickStart/Upgrade/">Upgrade</a></li>
                
                <li class=""><a href="/QuickStart_cn/UpgradeFromStorm.html">Migrate Application from Apache Storm to JStorm</a></li>
                
                <li class=""><a href="/QuickStart/UpgradeFromStorm.html">Migrate Application from Apache Storm to JStorm</a></li>
                
                <li class=""><a href="/QuickStart_cn/Compile.html">Build JStorm Source Code</a></li>
                
                <li class=""><a href="/QuickStart/Compile.html">Build JStorm Source Code</a></li>
                
              </ul>
            </li>

            <!-- ProgrammingGuide -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">ProgrammingGuide <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/ProgrammingGuide/DebugLocalApp.html">How to debug local topology?</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/StreamSplitJoin.html">How to split one stream or join multiple stream</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/Transaction.html">How to do exactly-once or transaction?</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/Trident.html">How to use Trident?</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/AdvancedUsage/">AdvancedUsage</a></li>
                  
              </ul>
            </li>

            <!-- Maintenance -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Maintenance <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Maintenance/Configuration.html">Explain Configuration Details</a></li>
                  
                  <li class=""><a href="/Maintenance/ConfigurationAutomacticSync.html">How to enable supervisor automatically sync configuration from Nimbus.</a></li>
                  
                  <li class=""><a href="/Maintenance/Isolation.html">How to enable resource isolation?</a></li>
                  
                  <li class=""><a href="/Maintenance/HealthCheck.html">How to enable supervisor health check?</a></li>
                  
                  <li class=""><a href="/Maintenance/JStorm-on-Yarn.html">How to create/remove/enlarge/reduce one JStorm logic cluster?</a></li>
                  
                  <li class=""><a href="/Maintenance/ClusterHA.html">How to provide application high availability when one cluster crash?</a></li>
                  
                  <li class=""><a href="/Maintenance/BlobStore.html">How to use BlobStore</a></li>
                  
              </ul>
            </li>

            <!-- FAQ -->
            <li class="hidden-sm "><a href="/FAQ/">FAQ</a></li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Language <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li class=""><a href="">English</a></li>
                  <li class=""><a href="/index_cn.html">中文</a></li>
              </ul>
            </li>
            <li class="hidden-sm "><a href="http://storm.taobao.org">Demo</a></li>
          </ul>          
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<div class="row">


  <!-- Sub Navigation -->
  <div class="col-sm-3">
    <ul id="sub-nav">
      
      
      
        
        <li><a href="/backup/quickstart/description_scenarios.html" class="">Description & Scenarios</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart/conception.html" class="">Basic Conception</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart/install.html" class="">How to install</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart/configuration.html" class="">JStorm Configuration</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart/difference.html" class="">Difference between Storm and JStorm</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart/migrate.html" class="active">Migrate from JStorm 0.9.x to 2.x</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart/upgrade.html" class="">Upgrade Guide</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart/user_define_log.html" class="">User Define log</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart/web_ui.html" class="">Manage Multi-cluster By Single Web UI</a>
          
        </li>
      
    </ul>
  </div>
  <!-- Main -->
  <div class="col-sm-9">
    <!-- Top anchor -->
    <a href="#top"></a>

    <div class="text">
      <!-- Main heading -->
      <h1>Migrate from JStorm 0.9.x to 2.x</h1>

      <!-- Content -->
      <p>JStorm 2.x are new version series, they have all features of 0.9.x, besides, they have these additional features:</p>

<ol>
  <li>
    <p>Better performance: jstorm 2.1.1 did a lot of optimization to JStorm core and metrics. In our performance tests, JStorm 2.1.1 is at least 10% faster than JStorm 0.9.8 in the worst case.</p>
  </li>
  <li>
    <p>Redesigned metrics core, from web ui(koala, not open source yet) we can see all history metrics instead of single static points in 0.9.x. It’s also very easy to use user-defined metrics, with a few lines of code, users can see history metrics in web ui.</p>
  </li>
  <li>
    <p>Minimum 1-min window metrics ensures more accurate metrics data.</p>
  </li>
  <li>
    <p>Supports simple log search and topology log search, both forward and backward search are supported.</p>
  </li>
  <li>
    <p>JStorm 2.1.1 supports jdk 1.8</p>
  </li>
</ol>

<p>But JStorm 2.1.1 is not quite backward compatible to JStorm 0.9x, mainly because changes to thrift/thrift dependency version and metrics client, the following steps are required to migrate JStorm 0.9.x to JStorm 2.1.1:</p>

<h3 id="upgrade-your-cluster">1.Upgrade your cluster</h3>

<p>See: <a href="/quickstart/upgrade">Upgrade Guide</a></p>

<h3 id="code-changes">2.Code changes</h3>

<p>a. Remove all old JStorm dependencies in your pom, including jstorm-client, jstorm-server, jstorm-client-extension.</p>

<p>b. Add jstorm-core dependency:</p>

<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.jstorm&lt;/groupId&gt;
    &lt;artifactId&gt;jstorm-core&lt;/artifactId&gt;
    &lt;version&gt;2.1.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>c. Rebuild your code, there might be errors in this step when you used user-defined metrics and MetricsClient since in JStorm 2.1.1 packages are changed, you may need to delete old packages and reimport the classes.</p>

<h3 id="about-logging-frameworks-very-important">3. About logging frameworks [Very Important]</h3>
<p>JStorm 2.1.1 has switched to logback instead of log4j in JStorm 0.9.x.</p>

<h4 id="use-logback-as-your-logging-framework">Use logback as your logging framework</h4>
<p>In most cases, log4j can be bridged to logback, the detailed steps are:</p>

<p>a. add slf4j-api, log4j-over-slf4j and logback dependencies:</p>

<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
    &lt;version&gt;1.7.5&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;log4j-over-slf4j&lt;/artifactId&gt;
    &lt;version&gt;1.7.10&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
    &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
    &lt;version&gt;1.0.13&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>b. Exclude slf4j-log4j12 in your pom since it conflicts with log4j-over-slf4j:</p>

<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
    &lt;version&gt;1.7.5&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre>

<p>Note that we use <code>&lt;scope&gt;provided&lt;/scope&gt;</code> to exclude slf4j-log4j12, it’s also fine to use <code>&lt;excludes&gt;</code>.
Theoretically this should do the work.</p>

<h4 id="use-log4j-as-your-logging-framework">Use log4j as your logging framework</h4>
<p>Above guides you to bridge log4j to logback, but if you use <code>Pattern, Appender</code> programmatically in your code, this may not work because some old versions of log4j-over-slf4j don’t provide the same class/methods, in this case you may have to use log4j.</p>

<p>The steps are kind of opposite:</p>

<p>a. exclude log4j-over-slf4j dependency(if any), exclude logback dependency, then add slf4j-log4j12 to your pom:</p>

<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;log4j-over-slf4j&lt;/artifactId&gt;
    &lt;version&gt;1.7.10&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
    &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
    &lt;version&gt;1.0.13&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
    &lt;version&gt;1.7.5&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;log4j&lt;/groupId&gt;
    &lt;artifactId&gt;log4j&lt;/artifactId&gt;
    &lt;version&gt;1.2.17&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>b. Besides changes in your pom, you also need to add a line of code before calling <code>TopologyBuilder.buildTopology</code>:</p>

<pre><code>ConfigExtension.setUserDefinedLog4jConf(conf, "jstorm.log4j.properties");
</code></pre>

<p>This line tells JStorm to use log4j and use <code>jstorm.log4j.properties</code> as log4j config(this file is in ${JSTORM_HOME}/conf), also you can provide your own log4j property file as long as it’s in your classpath or anywhere JStorm can find it.</p>

<p>You can also add this to your conf before submitting your topology.</p>

<pre><code>user.defined.log4j.conf: jstorm.log4j.properties
</code></pre>

<p>In you want to use log4j by default in your cluster rather than logback, you may put the above line into your storm.yaml and sync storm.yaml to all supervisors.</p>

<p>The cost of doing so is that when you want to use logback, you need to add following conf in your topology:</p>

<pre><code>user.defined.log4j.conf: 
</code></pre>

<p>The above conf resets log4j conf thus JStorm will use logback.</p>

<h3 id="how-to-use-user-defined-metrics">4.How to use user-defined metrics</h3>
<p>Use MetricClient to register user-defined metrics, the following kinds of metrics are supported:</p>

<p>COUNTER: as the name indicates, it records count like <code>emitted, acked, failed</code>.</p>

<p>METER: basically used to calculate qps/tps like <code>sendTps, recvTps</code> in JStorm.</p>

<p>GAUGE: used to record an instant value like <code>memUsed, cpuRatio, queueSize</code>,etc. <strong>Note that gauges cannot be aggregated</strong>, i.e., if you have registered a task-level gauge, JStorm won’t aggregate its value to component-level since it doesn’t make any sense.</p>

<p>HISTOGRAM: used for timing, like <code>EmitTime, nextTupleTime</code> etc.</p>

<p>You can refer to <code>TotalCount</code> class for detailed usage of user-defined metrics and MetricClient in sequence-split-merge project in the example module.</p>
      
    </div>
  </div>

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/js/jstorm.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    
  </body>
</html>
