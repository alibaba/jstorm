<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>JStorm 文档 : JStorm 任务的动态伸缩</title>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="icon" href="/img/favicon.png" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/jstorm.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!--




-->
    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="/"><img alt="jstorm" src="/img/jstorm-logo.png"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <!-- Example -->
            <li class="hidden-sm "><a href="/Example/">Example</a></li>

            <!-- Downloads -->
            <li class="hidden-sm "><a href="/Downloads/">Downloads</a></li>

            <!-- Performance -->
            <li class="hidden-sm "><a href="/Performance">Performance</a></li>

            <!-- QuickStart -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">QuickStart <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/QuickStart/BasicConception.html">Basic Conception</a></li>
                
                <li class=""><a href="/QuickStart/Example.html">Example</a></li>
                
                <li class=""><a href="/QuickStart/Deploy/">Deploy</a></li>
                
                <li class=""><a href="/QuickStart_cn/Upgrade/">Upgrade</a></li>
                
                <li class=""><a href="/QuickStart/Upgrade/">Upgrade</a></li>
                
                <li class=""><a href="/QuickStart_cn/UpgradeFromStorm.html">Migrate Application from Apache Storm to JStorm</a></li>
                
                <li class=""><a href="/QuickStart/UpgradeFromStorm.html">Migrate Application from Apache Storm to JStorm</a></li>
                
                <li class=""><a href="/QuickStart_cn/Compile.html">Build JStorm Source Code</a></li>
                
                <li class=""><a href="/QuickStart/Compile.html">Build JStorm Source Code</a></li>
                
              </ul>
            </li>

            <!-- ProgrammingGuide -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">ProgrammingGuide <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
              </ul>
            </li>

            <!-- Maintenance -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Maintenance <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
              </ul>
            </li>

            <!-- FAQ -->
            <li class="hidden-sm "><a href="/FAQ/">FAQ</a></li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Language <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li class=""><a href="">English</a></li>
                  <li class=""><a href="/index_cn.html">中文</a></li>
              </ul>
            </li>
            <li class="hidden-sm "><a href="http://storm.taobao.org">Demo</a></li>
          </ul>          
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<div class="row">


  <!-- Sub Navigation -->
  <div class="col-sm-3">
    <ul id="sub-nav">
      
      
      
        
        <li><a href="/backup/advance_cn/architecture_cn.html" class="">JStorm架构</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/difference_cn.html" class="">和Storm编程方式区别</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/ack_cn.html" class="">Ack 机制</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/resource_grouping_cn.html" class="">资源分组</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/split_merge_cn.html" class="">数据流分流和合并</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/transaction_cn.html" class="">事务</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/trident_cn.html" class="">Trident</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/programming_cn.html" class="">开发经验总结</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/operation_cn.html" class="">运维经验总结</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/perfomance_tuning_cn.html" class="">性能优化</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/rebalance_cn.html" class="active">JStorm 任务的动态伸缩</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/dynamic_config_cn.html" class="">动态更新配置文件</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/build_from_src_cn.html" class="">源码编译</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/backpressure.html" class="">限流降级</a>
          
        </li>
      
    </ul>
  </div>
  <!-- Main -->
  <div class="col-sm-9">
    <!-- Top anchor -->
    <a href="#top"></a>

    <div class="text">
      <!-- Main heading -->
      <h1>JStorm 任务的动态伸缩</h1>

      <!-- Content -->
      <p>从Release 0.9.7开始，JStorm可以支持topology任务的动态调整(支持扩容和缩容，以及同时的扩容和缩容)，动态调整的过程中   topology任务不会被重启或者下线，保证服务的持续性。在系统高负载和低负载时都能够有效的利用机器资源。
动态调整包括Task和Worker两个维度。</p>

<pre><code>- Task维度: Spout, Bolt，Acker并发数的动态调整
- Worker维度: Worker数的动态调整
</code></pre>

<p>Note: 动态伸缩当前仅对shuffer grouping有效(Shuffer, Localfirst, LocalOrShuffer)</p>

<hr />

<h2 id="section"><strong>动态伸缩的使用</strong></h2>

<h4 id="section-1">1. 命令行方式</h4>

<p>JStorm rebalance</p>

<pre><code>   USAGE: jstorm rebalance [-r] TopologyName [DelayTime] [NewConfig]
   e.g. jstorm rebalance SequenceTest conf.yaml

   参数说明:
   -r: 对所有task做重新调度
   TopologyName: Topology任务的名字
   DelayTime: 开始执行动态调整的延迟时间
   NewConfig: Spout, Bolt, Acker, Worker的新配置(当前仅支持yaml格式的配置文件)
            
</code></pre>

<p>配置文件例子</p>

<pre><code>   topology.workers: 4
   topology.acker.executors: 4

   topology.spout.parallelism:
     SequenceSpout : 2
   topology.bolt.parallelism:
     Total : 8
</code></pre>

<h4 id="api">2. API接口</h4>

<pre><code>   backtype.storm.command.rebalance:
   - public static void submitRebalance(String topologyName, RebalanceOptions options)
   - public static void submitRebalance(String topologyName, RebalanceOptions options, Map conf)
       Note: conf里带上zk信息，可以用来做对一个集群的远程提交
</code></pre>

<hr />

<h2 id="section-2"><strong>应用场景</strong></h2>

<h4 id="section-3">1. 根据系统的负载情况，进行任务的动态调整</h4>

<p>JStorm提供了task和worker维度一些系统监控负载情况查询的API。 用户可以通过这些API去判断当前任务的负载情况，由此去判断是否要对任务相关的component进行扩容或者缩容。当前提供的具体监控信息查询API如下</p>

<pre><code>   backtype.storm.metric.TopologyMetrics

   Task:
      - 反序列队列负载: public static Map&lt;Integer, Double&gt; getTaskDeserializeQueueStatus(String topologyName, Map stormConf)
      - 执行队列负载: public static Map&lt;Integer, Double&gt; getTaskExecuteQueueStatus(String topologyName, Map stormConf)
      - 序列化队列负载: Map&lt;Integer, Double&gt; getTaskSerializeQueueStatus(String topologyName, Map stormConf)

   Worker:
      - CPU利用率: public static Map&lt;Integer, Double&gt; getWorkerCpu(String topologyName, Map stormConf)
      - Memory使用量: public static Map&lt;Integer, Double&gt; getWorkerMemory(String topologyName, Map stormConf)
</code></pre>

<h4 id="section-4">2. 集群扩容时，对任务的扩容</h4>

<p>JStorm集群扩容时，可以对任务进行扩容，新的task会被分配在新的机器上。</p>

<hr />

<h2 id="section-5"><strong>常见问题</strong></h2>

<h4 id="section-6">1. 系统资源的利用率问题</h4>

<p>为了保证服务不中断，默认情况下，在扩容时会保证当前task, worker调度结果的不变。所以如果新的worker资源和task的扩容数，在和当前系统调度结果不匹配的情况下，会出现集群资源使用不均衡的问题。
比如:</p>

<pre><code>   worker-1: task-1, task-2, task-3
   rebalance with newConf: workerNum=4, taskNum=4
   = &gt; worker-1: task-1, task-2, task-3
       worker-2: task-4
</code></pre>

<p>在多次扩容后，如果出现了以上集群调度不均衡的情况。可用通过加参数”-r”去强制对所有的task做一次默认的均匀调度。</p>

<pre><code>   e.g. jstorm rebalance -r SequenceTest
</code></pre>
      
    </div>
  </div>

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/js/jstorm.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    
  </body>
</html>
