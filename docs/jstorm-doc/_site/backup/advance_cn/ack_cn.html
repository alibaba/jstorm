<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>JStorm 文档 : Ack 机制</title>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="icon" href="/img/favicon.png" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/jstorm.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!--




-->
    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="/"><img alt="jstorm" src="/img/jstorm-logo.png"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <!-- Example -->
            <li class="hidden-sm "><a href="/Example/">Example</a></li>

            <!-- Downloads -->
            <li class="hidden-sm "><a href="/Downloads/">Downloads</a></li>

            <!-- Performance -->
            <li class="hidden-sm "><a href="/Performance">Performance</a></li>

            <!-- QuickStart -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">QuickStart <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/QuickStart/BasicConception.html">Basic Conception</a></li>
                
                <li class=""><a href="/QuickStart/Example.html">Example</a></li>
                
                <li class=""><a href="/QuickStart/Deploy/">Deploy</a></li>
                
                <li class=""><a href="/QuickStart_cn/Upgrade/">Upgrade</a></li>
                
                <li class=""><a href="/QuickStart/Upgrade/">Upgrade</a></li>
                
                <li class=""><a href="/QuickStart_cn/UpgradeFromStorm.html">Migrate Application from Apache Storm to JStorm</a></li>
                
                <li class=""><a href="/QuickStart/UpgradeFromStorm.html">Migrate Application from Apache Storm to JStorm</a></li>
                
                <li class=""><a href="/QuickStart_cn/Compile.html">Build JStorm Source Code</a></li>
                
                <li class=""><a href="/QuickStart/Compile.html">Build JStorm Source Code</a></li>
                
              </ul>
            </li>

            <!-- ProgrammingGuide -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">ProgrammingGuide <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
              </ul>
            </li>

            <!-- Maintenance -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Maintenance <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
              </ul>
            </li>

            <!-- FAQ -->
            <li class="hidden-sm "><a href="/FAQ/">FAQ</a></li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Language <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li class=""><a href="">English</a></li>
                  <li class=""><a href="/index_cn.html">中文</a></li>
              </ul>
            </li>
            <li class="hidden-sm "><a href="http://storm.taobao.org">Demo</a></li>
          </ul>          
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<div class="row">


  <!-- Sub Navigation -->
  <div class="col-sm-3">
    <ul id="sub-nav">
      
      
      
        
        <li><a href="/backup/advance_cn/architecture_cn.html" class="">JStorm架构</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/difference_cn.html" class="">和Storm编程方式区别</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/ack_cn.html" class="active">Ack 机制</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/resource_grouping_cn.html" class="">资源分组</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/split_merge_cn.html" class="">数据流分流和合并</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/transaction_cn.html" class="">事务</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/trident_cn.html" class="">Trident</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/programming_cn.html" class="">开发经验总结</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/operation_cn.html" class="">运维经验总结</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/perfomance_tuning_cn.html" class="">性能优化</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/rebalance_cn.html" class="">JStorm 任务的动态伸缩</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/dynamic_config_cn.html" class="">动态更新配置文件</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/build_from_src_cn.html" class="">源码编译</a>
          
        </li>
      
        
        <li><a href="/backup/advance_cn/backpressure.html" class="">限流降级</a>
          
        </li>
      
    </ul>
  </div>
  <!-- Main -->
  <div class="col-sm-9">
    <!-- Top anchor -->
    <a href="#top"></a>

    <div class="text">
      <!-- Main heading -->
      <h1>Ack 机制</h1>

      <!-- Content -->
      <p>ack 机制是storm整个技术体系中非常闪亮的一个创新点， JStorm很好的继承了这个机制，并对原生storm的ack机制做了一点点代码优化。</p>

<h2 id="section">应用场景</h2>
<p>通过Ack机制，spout发送出去的每一条消息，都可以确定是被成功处理或失败处理， 从而可以让开发者采取动作。比如在Meta中，成功被处理，即可更新偏移量，当失败时，重复发送数据。</p>

<p>因此，<strong>通过Ack机制，很容易做到保证所有数据均被处理，一条都不漏。</strong></p>

<p>另外需要注意的，<strong>当spout触发fail动作时，不会自动重发失败的tuple，需要spout自己重新获取数据，手动重新再发送一次</strong></p>

<p>ack机制即， spout发送的每一条消息，</p>

<ul>
  <li>在规定的时间内，spout收到Acker的ack响应，即认为该tuple 被后续bolt成功处理</li>
  <li>在规定的时间内，没有收到Acker的ack响应tuple，就触发fail动作，即认为该tuple处理失败，</li>
  <li>或者收到Acker发送的fail响应tuple，也认为失败，触发fail动作</li>
</ul>

<p>另外Ack机制还常用于限流作用：
为了避免spout发送数据太快，而bolt处理太慢，常常设置pending数，当spout有等于或超过pending数的tuple没有收到ack或fail响应时，跳过执行nextTuple， 从而限制spout发送数据。</p>

<p>通过<code>conf.put(Config.TOPOLOGY_MAX_SPOUT_PENDING, pending);</code>设置spout pend数。</p>

<h2 id="ack">如何使用Ack机制</h2>
<ul>
  <li>spout 在发送数据的时候带上msgid</li>
  <li>设置acker数至少大于0；<code>Config.setNumAckers(conf, ackerParal);</code></li>
  <li>在bolt中完成处理tuple时，执行OutputCollector.ack(tuple), 当失败处理时，执行OutputCollector.fail(tuple);
** 推荐使用IBasicBolt， 因为IBasicBolt 自动封装了OutputCollector.ack(tuple), 处理失败时，请抛出FailedException，则自动执行OutputCollector.fail(tuple)</li>
</ul>

<h2 id="ack-1">如何关闭Ack机制</h2>
<p>有2种途径</p>

<ul>
  <li>spout发送数据是不带上msgid</li>
  <li>设置acker数等于0</li>
</ul>

<p>#Acker的原理：
acker的原理如下图所示：</p>

<p><img src="/img/advance_cn/ack/acker.jpg" alt="acker" /></p>

<p>当Acker中rootid的value为0时，就发送ack 响应给spout，如果直接收到fail消息，则发送fail响应给spout</p>
      
    </div>
  </div>

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/js/jstorm.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    
  </body>
</html>
