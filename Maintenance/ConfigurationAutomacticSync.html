<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>JStorm Documentation : How to enable supervisor automatically sync configuration from Nimbus.</title>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="icon" href="/img/favicon.png" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/jstorm.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!--




-->
    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="/"><img alt="jstorm" src="/img/jstorm-logo.png"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            
            <!-- Downloads -->
            <li class="hidden-sm "><a href="/Downloads.html">Downloads</a></li>

            <!-- Performance -->
            <li class="hidden-sm "><a href="/Performance">Performance</a></li>

            <!-- QuickStart -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">QuickStart <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/QuickStart/BasicConception.html">Basic Conception</a></li>
                
                <li class=""><a href="/QuickStart/Example.html">Example</a></li>
                
                <li class=""><a href="/QuickStart/Deploy/index.html">Deploy</a></li>
                
                <li class=""><a href="/QuickStart/Upgrade/index.html">Upgrade</a></li>
                
                <li class=""><a href="/QuickStart/UpgradeFromStorm.html">Migrate from Apache Storm</a></li>
                
                <li class=""><a href="/QuickStart/Compile.html">Compile JStorm</a></li>
                
              </ul>
            </li>

            <!-- ProgrammingGuide -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">ProgrammingGuide <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/ProgrammingGuide/DebugLocalApp.html">Local Debug</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/StreamSplitJoin.html">Split-Merge-Stream</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/Transaction.html">Transaction</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/Trident.html">Trident</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/AdvancedUsage/index.html">Advanced Usage</a></li>
                  
              </ul>
            </li>

            <!-- Maintenance -->
            <li class="dropdown active">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Maintenance <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Maintenance/Configuration.html">Configuration</a></li>
                  
                  <li class="active"><a href="/Maintenance/ConfigurationAutomacticSync.html">Automatically Sync Configuration</a></li>
                  
                  <li class=""><a href="/Maintenance/Isolation.html">Resource Isolation</a></li>
                  
                  <li class=""><a href="/Maintenance/JStormMetrics.html">JStorm Metrics</a></li>
                  
                  <li class=""><a href="/Maintenance/HealthCheck.html">Supervisor Health Check</a></li>
                  
                  <li class=""><a href="/Maintenance/JStorm-on-Yarn.html">JStorm-on-Yarn</a></li>
                  
                  <li class=""><a href="/Maintenance/ClusterHA.html">Cluster HA</a></li>
                  
                  <li class=""><a href="/Maintenance/SupervisorWorker.html">Supervisor-Generate-Workers</a></li>
                  
                  <li class=""><a href="/Maintenance/DynamicAdjustLog.html">Dynamic Adjust Log</a></li>
                  
              </ul>
            </li>

            <!-- FAQ -->
            <li class="hidden-sm "><a href="/FAQ/">FAQ</a></li>

            <!-- Community -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Community <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Community/Email.html">Email List</a></li>
                  
                  <li class=""><a href="/Community/Committers.html">Committer List</a></li>
                  
                  <li class=""><a href="/Community/Events-Meetups.html">Events and Meetups</a></li>
                  
                  <li class=""><a href="/Community/Issues.html">Track issues</a></li>
                  
                  <li class=""><a href="/Community/JStormUsers.html">JStorm User List</a></li>
                  
              </ul>
            </li>


          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Language <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li class=""><a href="/index.html">English</a></li>
                  <li class=""><a href="/index_cn.html">中文</a></li>

              </ul>
            </li>
          </ul>          
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<div class="row">

  
  
  <div class="col-md-8 col-md-offset-2 text">
    <h1>How to enable supervisor automatically sync configuration from Nimbus.</h1>
	<ul id="markdown-toc">
  <li><a href="#precondition" id="markdown-toc-precondition">Precondition</a></li>
  <li><a href="#background" id="markdown-toc-background">Background</a></li>
  <li><a href="#implementation" id="markdown-toc-implementation">Implementation</a>    <ul>
      <li><a href="#standalone" id="markdown-toc-standalone">Standalone</a></li>
      <li><a href="#jstorm-on-yarn" id="markdown-toc-jstorm-on-yarn">Jstorm-on-yarn</a></li>
    </ul>
  </li>
  <li><a href="#operation" id="markdown-toc-operation">Operation</a></li>
  <li><a href="#todo" id="markdown-toc-todo">TODO</a></li>
</ul>

<h2 id="precondition">Precondition</h2>

<p>The version of jstorm is greater than or equal to 2.2.0</p>

<h2 id="background">Background</h2>

<p>Currently modifying the jstorm cluster configuration (storm.yaml), needs manually access to the gateway to copy storm.yaml, edit, and then use the batch scp to copy to the cluster and restart the whole cluster. If you need to modify multiple clusters at the same time, it is too inefficient and costly.</p>

<p>The global configuration pushing is mainly developed for the batching modification of cluster configuration.</p>

<h2 id="implementation">Implementation</h2>

<h3 id="standalone">Standalone</h3>

<p>Add ConfigUpdateHandler plugin that allows dynamic modification of storm.yaml configuration to nimbus in jstorm-core. The default DefaultConfigUpdateHandler do nothing, the same as there is no plugin.</p>

<p>Implementing a DiamondConfigUpdateHandler (external / jstorm-configserver module), the plug-in configuration updates through the diamond. When an update is detected, it will backup the current storm.yaml (reservations up to three backups which are storm.yaml.1, storm.yaml.2, storm.yaml.3), and the latest configuration will be written to the storm .yaml.</p>

<p>The supervisor has a configuration update thread (SupervisorRefershConfig), requesting the latest configuration from nimbus once about every half a minute, and compare with the local configuration. If they are not the same, then do the backup and cover the local configuration to update the configuration at cluster level dynamically.</p>

<p>Generally speaking, the configuration updates are pushed from the diamond to the nimbus, nimbus and then pull from the supervisor.</p>

<h3 id="jstorm-on-yarn">Jstorm-on-yarn</h3>

<p>In the case of yarn, the situation is a little bit complex. Because some configuration items of the supervisor in yarn is dynamically generated, such as storm.local.dir, jstorm.log.dir, etc. Then if the configuration of supervisor is  directly overwrote by the configuration of nimbus, there is a problem.</p>

<p>Thus, in the case of yarn, an new configuration item is added and the default value is as below:</p>

<pre><code>jstorm.yarn.conf.blacklist: "jstorm.home, jstorm.log.dir, storm.local.dir, java.library.path"
</code></pre>

<p>This configuration item indicates NOT to overwrite the local configurations of supervisor by the configurations of nimbus.</p>

<p>On implementation, when SupervisorRefershConfig is in initialization, these configuration items will be saved, called retainedYarnConfig.</p>

<p>These configuration items are filtered at the following comparison. If the configuration is different, then <strong>the configuration of nimbus is used and appending the retainedYarnConfig at the end</strong>. An new configuration file then will be generated and cover local storm.yaml.</p>

<p>Meanwhile, in order to distinguish whether it is yarn environment, it needs the supervisor of yarn to add <code>-Djstorm-on-yarn = true</code> parameter at startup.</p>

<p>Note that the yarn configuration blacklist currently supports only simple k-v format. If you configure the value in complexity format as list or map, there is a problem.</p>

<h2 id="operation">Operation</h2>

<ol>
  <li>
    <p>Trigger configuration update for a particular cluster / all clusters in the management and control platform</p>
  </li>
  <li>
    <p>The management and control platform will pull the current configuration from the nimbus, allowing users editing online and pushing after that.</p>
  </li>
  <li>
    <p>Every cluster will saved the current configuration file in diamond, with a dataId as the cluster.name in configuration file. In order to ensure that all environments can receive the configuration, koala will pushed the configuration to all the environments in diamond (central and units).</p>
  </li>
  <li>
    <p>Nimbus receives the configuration, do check with the local one. If they are not the same, then update it.</p>
  </li>
  <li>
    <p>Supervisor pull configuration from nimbus, check with the local configuration and confirm if it needs to update depending on if it is in the yarn environment.</p>
  </li>
</ol>

<h2 id="todo">TODO</h2>

<p>Currently after receiving the new configuration, it will actually invoke RefreshableComponent.refresh to dynamically update the configuration. But currently supports limited dynamic update configurations. They are mainly metrics or log related configuration. We will support more configuration items which can updated automatically in version 2.2.1.</p>

  <div class="footer">
      Google Groups: <a target="_blank" href="https://groups.google.com/forum/#!forum/jstorm-user">jstorm-user</a>, QQ Groups: 228374502
      </p>
      Caught a mistake or want to contribute to the documentation? 
      <a href="https://github.com/alibaba/jstorm/edit/master/docs/jstorm-doc/Maintenance/ConfigurationAutomacticSync.md" target="_blank">
        Edit this page on Github!
      </a>
  </div>
  

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/js/jstorm.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    <!--
     -->
  </body>
</html>
