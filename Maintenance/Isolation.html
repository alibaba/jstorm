<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>JStorm Documentation : How to enable resource isolation?</title>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="icon" href="/img/favicon.png" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/jstorm.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!--




-->
    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="/"><img alt="jstorm" src="/img/jstorm-logo.png"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            
            <!-- Downloads -->
            <li class="hidden-sm "><a href="/Downloads.html">Downloads</a></li>

            <!-- Performance -->
            <li class="hidden-sm "><a href="/Performance">Performance</a></li>

            <!-- QuickStart -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">QuickStart <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/QuickStart/BasicConception.html">Basic Conception</a></li>
                
                <li class=""><a href="/QuickStart/Example.html">Example</a></li>
                
                <li class=""><a href="/QuickStart/Deploy/index.html">Deploy</a></li>
                
                <li class=""><a href="/QuickStart/Upgrade/index.html">Upgrade</a></li>
                
                <li class=""><a href="/QuickStart/UpgradeFromStorm.html">Migrate from Apache Storm</a></li>
                
                <li class=""><a href="/QuickStart/Compile.html">Compile JStorm</a></li>
                
              </ul>
            </li>

            <!-- ProgrammingGuide -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">ProgrammingGuide <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/ProgrammingGuide/DebugLocalApp.html">Local Debug</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/StreamSplitJoin.html">Split-Merge-Stream</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/Transaction.html">Transaction</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/Trident.html">Trident</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/AdvancedUsage/index.html">Advanced Usage</a></li>
                  
              </ul>
            </li>

            <!-- Maintenance -->
            <li class="dropdown active">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Maintenance <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Maintenance/Configuration.html">Configuration</a></li>
                  
                  <li class=""><a href="/Maintenance/ConfigurationAutomacticSync.html">Automatically Sync Configuration</a></li>
                  
                  <li class="active"><a href="/Maintenance/Isolation.html">Resource Isolation</a></li>
                  
                  <li class=""><a href="/Maintenance/JStormMetrics.html">JStorm Metrics</a></li>
                  
                  <li class=""><a href="/Maintenance/HealthCheck.html">Supervisor Health Check</a></li>
                  
                  <li class=""><a href="/Maintenance/JStorm-on-Yarn.html">JStorm-on-Yarn</a></li>
                  
                  <li class=""><a href="/Maintenance/ClusterHA.html">Cluster HA</a></li>
                  
                  <li class=""><a href="/Maintenance/SupervisorWorker.html">Supervisor-Generate-Workers</a></li>
                  
                  <li class=""><a href="/Maintenance/DynamicAdjustLog.html">Dynamic Adjust Log</a></li>
                  
              </ul>
            </li>

            <!-- FAQ -->
            <li class="hidden-sm "><a href="/FAQ/">FAQ</a></li>

            <!-- Community -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Community <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Community/Email.html">Email List</a></li>
                  
                  <li class=""><a href="/Community/Committers.html">Committer List</a></li>
                  
                  <li class=""><a href="/Community/Events-Meetups.html">Events and Meetups</a></li>
                  
                  <li class=""><a href="/Community/Issues.html">Track issues</a></li>
                  
                  <li class=""><a href="/Community/JStormUsers.html">JStorm User List</a></li>
                  
              </ul>
            </li>


          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Language <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li class=""><a href="/index.html">English</a></li>
                  <li class=""><a href="/index_cn.html">中文</a></li>

              </ul>
            </li>
          </ul>          
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<div class="row">

  
  
  <div class="col-md-8 col-md-offset-2 text">
    <h1>How to enable resource isolation?</h1>
	<ul id="markdown-toc">
  <li><a href="#overview" id="markdown-toc-overview">Overview</a></li>
  <li><a href="#configuration" id="markdown-toc-configuration">Configuration</a>    <ul>
      <li><a href="#start-cgroup-service" id="markdown-toc-start-cgroup-service">Start cgroup service</a></li>
      <li><a href="#or-directly-run-command" id="markdown-toc-or-directly-run-command">Or directly Run Command</a></li>
      <li><a href="#open-cgroup-in-jstorm-configuration-file-configure-stormyaml" id="markdown-toc-open-cgroup-in-jstorm-configuration-file-configure-stormyaml">Open cgroup in jstorm configuration file, configure storm.yaml</a></li>
    </ul>
  </li>
</ul>

<h1 id="overview">Overview</h1>
<p>Resource isolation is the ability that every computing platform needs. The resource isolation are divided into several levels:</p>

<ul>
  <li>Between clusters</li>
  <li>
    <ul>
      <li>Standalone, deploy the cluster in directly physical isolation. It has the best resource isolation effect. The disadvantage is easy to waste resources.</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>Jstorm-on-yarn, Jstorm-on-docker, through yarn or docker-swam, deploy multiple logical clusters on a physical cluster, and the resource is isolated between logic clusters.</li>
    </ul>
  </li>
  <li>Inside a cluster</li>
  <li>
    <ul>
      <li>Custom scheduling, the user can force some tasks to run on certain machines and occupy them by jstorm customized scheduling.</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>Worker-cgroup, set the cgroup on the worker, isolate the cpu and memory resource.</li>
    </ul>
  </li>
</ul>

<p>This article mainly describes the worker-cgroup configuration inside the jstorm cluster.</p>

<p>Additionally: the 2 cgroup ways that industry commonly use, is not efficiency as the jstorm’s way.</p>

<ul>
  <li>
    <p>Tied to cpu core, such as a commonly used way on yarn, a worker is bound to a cpu core. The biggest problem is that in this way, 
when the worker is busy, it can not expanded to 2 or 3 cores automatically. 
It often makes the task can not complete. When the worker is not busy, the cpu core can not be shared. 
In the true running environment, we found that the cpu occupation is very low in the cluster in this way.
Only a few worker can fully use the core which it binds with, most of the workers are in an idle status.</p>
  </li>
  <li>
    <p>Shared, all workers apply for a certain weight, assuming that there are three workers. Worker A weight of 100, in the cpu running wild status. Worker B weight 200, is in the cpu running wild status. Worker C weight of 100 and in normal status. The final result is that the worker A approximately used 1/3 of the cpu, worker B approximately used 2/3 of the cpu, worker C used little of the cpu. But the entire machine load will be very heavy, it alarms continuously.</p>
  </li>
</ul>

<p>Jstorm use a shared + limited way which is the workers apply cpu according to their weights, but at the same time set a threshold of worker’s cpu (default 4-core). That is on a shared basis, limits the cpu of each worker used can not be more than four cores. It ensures when a worker is busy, it can automatically use 2 or 3 cores. In idle time, worker can free the cpu to let other workers use. Even more critical is that it will not let a worker run wildly. It will not lead to the machine load is very high because a worker runs wildly and the other workers could not use the cpu.</p>

<p>In the actual using, this way has a very good effect.</p>

<p>Additionally: cgroups is the abbreviation of control groups, which is a mechanism that provided by Linux kernel and can be used to restrict, record, isolate the physical resources used by process group(such as: cpu, memory, IO, etc.).</p>

<h1 id="configuration">Configuration</h1>

<p>In Jstorm, we use cgroup manage the cpu hardware resources. Before use, check the following items and configuration.</p>

<ul>
  <li>
    <p>Check the current user’s uid and gid in the file /etc/passwd. Assuming that the current user is admin, then check waht the admin uid and gid is in the file /etc/passwd.</p>
  </li>
  <li>
    <p>Whether the Cgroup function is supported or not in current system kernel version.</p>
  </li>
</ul>

<p>*Check if /etc/cgconfig.conf exists. If not, please “yum install libcgroup”. If it exists, set cpu subsystem mount directory location. And modify the corresponding uid/gid in the configuration file to the uid/gid of the user that start jstorm. In this case 500, for example. Note that it is set according to the first step.</p>

<pre><code>  mount {    
      cpu = /cgroup/cpu;
  }
  

  group jstorm {
       perm {
               task {
                      uid = 500;
                      gid = 500;
               }
               admin {
                      uid = 500;
                      gid = 500;
               }
       }
       cpu {
       }
  }
</code></pre>

<p>This is a cgconfig.conf profile examples. For example the jstorm start user is admin. The uid/gid of admin in the current System is 500 (see /etc/passwd can view the uid and gid), then jstorm directory uid/gid also needs to be set to the same value in the corresponding cpu subsystem. So jstorm have the appropriate permissions that can create the corresponding directory and make related settings in this directory for each jstorm process that needs to be isolated of resources.</p>

<h3 id="start-cgroup-service">Start cgroup service</h3>

<pre><code>service cgconfig restart
chkconfig --level 23456 cgconfig on
</code></pre>

<p>Note: cgconfig.conf can only be modified in root mode.</p>

<h3 id="or-directly-run-command">Or directly Run Command</h3>

<pre><code>mkdir /cgroup/cpu
mount  -t cgroup -o cpu none /cgroup/cpu
mkdir /cgroup/cpu/jstorm
chown admin:admin /cgroup/cpu/jstorm
</code></pre>

<h2 id="open-cgroup-in-jstorm-configuration-file-configure-stormyaml">Open cgroup in jstorm configuration file, configure storm.yaml</h2>

<pre><code>   supervisor.enable.cgroup: true
</code></pre>

  <div class="footer">
      Google Groups: <a target="_blank" href="https://groups.google.com/forum/#!forum/jstorm-user">jstorm-user</a>, QQ Groups: 228374502
      </p>
      Caught a mistake or want to contribute to the documentation? 
      <a href="https://github.com/alibaba/jstorm/edit/master/docs/jstorm-doc/Maintenance/Isolation.md" target="_blank">
        Edit this page on Github!
      </a>
  </div>
  

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/js/jstorm.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    <!--
     -->
  </body>
</html>
