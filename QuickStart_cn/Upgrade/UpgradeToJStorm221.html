<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>JStorm 文档 : 从JStorm2.1.1升级到JStorm2.2.1</title>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="icon" href="/img/favicon.png" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/jstorm.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!--




-->
    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="/"><img alt="jstorm" src="/img/jstorm-logo.png"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <!-- Downloads -->
            <li class="hidden-sm "><a href="/Downloads.html">Downloads</a></li>

            <!-- Performance -->
            <li class="hidden-sm "><a href="/Performance_cn">Performance</a></li>

            <!-- QuickStart -->
            <li class="dropdown active">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">QuickStart <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/QuickStart_cn/BasicConception.html">5分钟基础概念(新手第一篇)</a></li>
                
                <li class=""><a href="/QuickStart_cn/Example.html">入门Example</a></li>
                
                <li class=""><a href="/QuickStart_cn/Deploy/index.html">安装部署</a></li>
                
                <li class=""><a href="/QuickStart_cn/Upgrade/index.html">升级</a></li>
                
                <li class=""><a href="/QuickStart_cn/UpgradeFromStorm.html">从Apache Storm升级到JStorm</a></li>
                
                <li class=""><a href="/QuickStart_cn/Compile.html">编译JStorm</a></li>
                
              </ul>
            </li>

            <!-- ProgrammingGuide -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">ProgrammingGuide <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/ProgrammingGuide_cn/DebugLocalApp.html">本地调试</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/StreamSplitJoin.html">数据流分流合并</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/Transaction/index.html">事务</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/Trident/index.html">Trident</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/AdvancedUsage/index.html">Advanced Usage</a></li>
                  
              </ul>
            </li>

            <!-- Maintenance -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">运维 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Maintenance_cn/Configuration.html">配置注解</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/ConfigurationAutomacticSync.html">自动同步配置文件</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/Isolation.html">资源隔离</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/JStormMetrics.html">JStorm Metrics</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/HealthCheck.html">Supervisor自检</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/JStorm-on-Yarn.html">JStorm-on-Yarn</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/ClusterHA.html">同城灾备&异地灾备</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/BlobStore.html">BlobStore</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/SupervisorWorker.html">生成worker列表算法</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/DynamicAdjustLog.html">动态调整日志</a></li>
                  
              </ul>
            </li>

            <!-- FAQ -->
            <li class="hidden-sm "><a href="/FAQ_cn/">FAQ</a></li>



            <!-- Community -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">社区 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Community/Email.html">Email List</a></li>
                  
                  <li class=""><a href="/Community/Committers.html">Committer List</a></li>
                  
                  <li class=""><a href="/Community/Events-Meetups.html">Events and Meetups</a></li>
                  
                  <li class=""><a href="/Community/Issues.html">Track issues</a></li>
                  
                  <li class=""><a href="/Community/JStormUsers.html">JStorm User List</a></li>
                  
              </ul>
            </li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Language <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li class=""><a href="/index.html">English</a></li>
                  <li class=""><a href="/index_cn.html">中文</a></li>

              </ul>
            </li>
          </ul>          
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<div class="row">


  <!-- Sub Navigation -->
  <div class="col-sm-3">
    <ul id="sub-nav">
      
      
      
        
        
        
        <li><a href="/QuickStart_cn/Upgrade/index.html" class="">升级</a>
          
        </li>
      
        
        
        
        <li><a href="/QuickStart_cn/Upgrade/UpgradeCluster.html" class="">集群升级</a>
          
        </li>
      
        
        
        
        <li><a href="/QuickStart_cn/Upgrade/UpgradeApplication.html" class="">从JStorm0.9.x升级到JStorm2.1.1</a>
          
        </li>
      
        
        
        
        <li><a href="/QuickStart_cn/Upgrade/UpgradeToJStorm221.html" class="active">从JStorm2.1.1升级到JStorm2.2.1</a>
          
        </li>
      
    </ul>
  </div>
  <!-- Main -->
  <div class="col-sm-9">
    <!-- Top anchor -->
    <a href="#top"></a>

    <div class="text">
      <!-- Main heading -->
      <h1>从JStorm2.1.1升级到JStorm2.2.1</h1>

      <!-- Content -->
      <ul id="markdown-toc">
  <li><a href="#集群重新安装" id="markdown-toc-集群重新安装">集群重新安装</a>    <ul>
      <li><a href="#配置自动同步" id="markdown-toc-配置自动同步">配置自动同步</a></li>
      <li><a href="#ext模块" id="markdown-toc-ext模块">ext模块</a></li>
    </ul>
  </li>
  <li><a href="#代码修改" id="markdown-toc-代码修改">代码修改</a></li>
  <li><a href="#关于序列化" id="markdown-toc-关于序列化">关于序列化</a>    <ul>
      <li><a href="#关闭kryo" id="markdown-toc-关闭kryo">关闭kryo</a></li>
      <li><a href="#自定义序列化器" id="markdown-toc-自定义序列化器">自定义序列化器</a></li>
    </ul>
  </li>
  <li><a href="#日志系统" id="markdown-toc-日志系统">日志系统</a></li>
  <li><a href="#关于classloader" id="markdown-toc-关于classloader">关于classloader</a></li>
</ul>

<p>本文主要讲述如何从2.1.1升级到2.2.1。</p>

<h2 id="集群重新安装">集群重新安装</h2>
<p>参见集群升级指南，几点需要注意的</p>

<h3 id="配置自动同步">配置自动同步</h3>
<p>2.2.1添加了一个新功能：配置自动同步，这意味着，supervisor会自动从nimbus同步最新的storm.yaml。所以，如果你想要同步集群的配置，
只需要到nimbus master上修改一下storm.yaml，保存，配置就会被同步到supervisor。但是如果你想要每个supervisor都有一些不同的配置，
那需要加一个配置：<code>jstorm.yarn.conf.blacklist</code>。如：</p>

<pre><code>jstorm.yarn.conf.blacklist: "jstorm.log.dir, jstorm.home"
</code></pre>
<p>但是目前的配置同步有一个问题，对于复杂类型的，比如port list的：</p>

<pre><code>supervisor.slots.ports:
    -6800
    -6801
</code></pre>

<p>如果在conf blacklist中设置了这种复杂值类型的配置项，那么在同步的时候可能会出现问题。这时需要你修改一下配置，把yaml中的值改成list类型的值，即：</p>

<pre><code>supervisor.slots.ports: [6800,6801]
</code></pre>
<p>同时，你也可以自定义你的<code>nimbus.config.update.handler.class</code>。只需实现<code>ConfigUpdateHandler</code>接口即可。这样可以通过其他的方式来动态修改集群
的配置，如通过外部的配置中心修改特定集群的配置。</p>

<p>最后<strong>注意</strong>：配置的自动更新，并不意味着会自动生效。目前来说，还是需要重启nimbus或supervisor才能让大部分的配置自动生效。</p>

<h3 id="ext模块">ext模块</h3>
<p>2.2.1开始，nimbus和supervisor支持加载external library。举例来说，你写了一个metric uploader的实现，要作为插件plugin到nimbus中。那么：</p>

<ol>
  <li>
    <p>首先，你写好代码，为这个插件打出一个单独的jar包（或者可能还有一堆第三方依赖包）。</p>
  </li>
  <li>
    <p>创建目录：{jstorm.home}/lib/ext，然后进入ext目录，创建一个子目录，如: metric_plugin。</p>
  </li>
  <li>
    <p>把你的jar及依赖复制到metric_plugin。</p>
  </li>
  <li>
    <p>修改storm.yaml，加入配置：<code>nimbus.external: metric_plugin</code>。</p>
  </li>
  <li>
    <p>重启nimbus，这时nimbus启动的时候就会自动把metric_plugin/*加入到它的classpath中，这样就能访问到你的插件类及其功能了。
同样的，supervisor也支持supervisor.external功能。</p>
  </li>
</ol>

<h2 id="代码修改">代码修改</h2>

<p>2.1.1到2.2.1代码改动相对较小，大部分是兼容的，只需要少许修改即可完成升级。</p>

<p>a. 添加jstorm-core依赖：</p>

<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.jstorm&lt;/groupId&gt;
    &lt;artifactId&gt;jstorm-core&lt;/artifactId&gt;
    &lt;version&gt;2.2.1&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre>

<p>c. 重新编译。这一步可能会出错，因为如果你用了自定义metrics，很可能在2.2.1中，package名或者接口名都已经发生了变化，
你需要把原来的package依赖删了，重新import一下。</p>

<p>d. 接下来这一步比较<strong>重要</strong>，从jstorm 2.2.1开始，jstorm-core内部对许多容易产生冲突的包做了shade，如snakeyaml，curator-framework等。
如果你的应用依赖了snakeyaml做yaml的解析，或者用了curator framework，并且之前是依赖于jstorm的版本的，即，应用自己的代码中没有直接或者间接
加上这个依赖，那么在升级到2.2.1之后，有可能会出现相关的类找不到，这时需要你在应用代码中手动加上这些依赖。</p>

<h2 id="关于序列化">关于序列化</h2>
<p>从2.2.1开始，jstorm默认开启了kryo序列化，这要求传输的对象（及其所有非static及transient变量）需要有无参构造函数</p>

<p>重复3遍</p>

<pre><code>所有传输对象 含有无参构造函数
所有传输对象 含有无参构造函数
所有传输对象 含有无参构造函数
</code></pre>

<p>否则可能会抛出类似于下面的异常：</p>

<pre><code>Exception in thread "main" com.esotericsoftware.kryo.KryoException: Class cannot be created (missing no-arg constructor): java.util.List

</code></pre>

<p>当无法为所有对象创建出无参构造函数时，有两种解决方法：</p>

<h3 id="关闭kryo">关闭kryo</h3>

<p>在conf中添加如下配置可以做到：</p>

<pre><code>topology.fall.back.on.java.serialization: true
</code></pre>
<p>这样就会使用java的默认序列化方式</p>

<h3 id="自定义序列化器">自定义序列化器</h3>

<p>如果对性能要求比较高，你可能并不想这么做，那么就需要为你的类实现一个自定义的kryo序列化器。
可以参考源码中sequence-split-merge代码中<code>PairSerializer</code>类。</p>

<p>举例来说，ByteBuffer是没有无参构造函数的(包括HeapByteBuffer)，而且是个抽象类，我们自定义的ByteBufferSerializer代码如下：</p>

<pre><code class="language-java">public class KryoByteBufferSerializer extends Serializer&lt;ByteBuffer&gt; {

    @Override
    public void write(Kryo kryo, Output output, ByteBuffer object) {
        output.writeInt(object.array().length);
        output.write(object.array());
    }

    @Override
    public ByteBuffer read(Kryo kryo, Input input, Class&lt;ByteBuffer&gt; type) {
        int len = input.readInt();
        return ByteBuffer.wrap(input.readBytes(len));
    }
}
</code></pre>

<p>然后把serializer注册到kryo：</p>

<pre><code>Config.registerSerialization(stormConf, "java.nio.HeapByteBuffer", KryoByteBufferSerializer.class);
</code></pre>

<h2 id="日志系统">日志系统</h2>

<p>请参考0.9.x升级到2.x的文档</p>

<h2 id="关于classloader">关于classloader</h2>

<p>上面已经提到，jstorm-core对容易冲突的依赖做了shade，因此基本上不再需要开启classloader来解决。
如果你之前有应用开启过classloader，那么可以考虑在升级到2.2.1之后，关掉classloader。</p>
      
      <div class="footer">
      Google Groups: <a target="_blank" href="https://groups.google.com/forum/#!forum/jstorm-user">jstorm-user</a>, QQ Groups: 228374502
      </p>
 
      发现错误？想参与编辑？
      <a href="https://github.com/alibaba/jstorm/edit/master/docs/jstorm-doc/QuickStart_cn/Upgrade/UpgradeToJStorm221.md" target="_blank">
        在 Github 上编辑此页！
      </a>
  </div>
    </div>
  </div>

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/js/jstorm.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    <!--
     -->
  </body>
</html>
