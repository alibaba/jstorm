<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>JStorm 文档 : How to debug local topology?</title>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="icon" href="/img/favicon.png" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/jstorm.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!--




-->
    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="/"><img alt="jstorm" src="/img/jstorm-logo.png"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <!-- Downloads -->
            <li class="hidden-sm "><a href="/Downloads.html">Downloads</a></li>

            <!-- Performance -->
            <li class="hidden-sm "><a href="/Performance_cn">Performance</a></li>

            <!-- QuickStart -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">QuickStart <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/QuickStart_cn/BasicConception.html">5分钟基础概念(新手第一篇)</a></li>
                
                <li class=""><a href="/QuickStart_cn/Example.html">入门Example</a></li>
                
                <li class=""><a href="/QuickStart_cn/Deploy/index.html">安装部署</a></li>
                
                <li class=""><a href="/QuickStart_cn/Upgrade/index.html">升级</a></li>
                
                <li class=""><a href="/QuickStart_cn/UpgradeFromStorm.html">从Apache Storm升级到JStorm</a></li>
                
                <li class=""><a href="/QuickStart_cn/Compile.html">编译JStorm</a></li>
                
              </ul>
            </li>

            <!-- ProgrammingGuide -->
            <li class="dropdown active">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">ProgrammingGuide <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class="active"><a href="/ProgrammingGuide_cn/DebugLocalApp.html">本地调试</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/StreamSplitJoin.html">数据流分流合并</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/Transaction/index.html">事务</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/Trident/index.html">Trident</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/AdvancedUsage/index.html">Advanced Usage</a></li>
                  
              </ul>
            </li>

            <!-- Maintenance -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">运维 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Maintenance_cn/Configuration.html">配置注解</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/ConfigurationAutomacticSync.html">自动同步配置文件</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/Isolation.html">资源隔离</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/JStormMetrics.html">JStorm Metrics</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/HealthCheck.html">Supervisor自检</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/JStorm-on-Yarn.html">JStorm-on-Yarn</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/ClusterHA.html">同城灾备&异地灾备</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/BlobStore.html">BlobStore</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/SupervisorWorker.html">生成worker列表算法</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/DynamicAdjustLog.html">动态调整日志</a></li>
                  
              </ul>
            </li>

            <!-- FAQ -->
            <li class="hidden-sm "><a href="/FAQ_cn/">FAQ</a></li>



            <!-- Community -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">社区 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Community/Email.html">Email List</a></li>
                  
                  <li class=""><a href="/Community/Committers.html">Committer List</a></li>
                  
                  <li class=""><a href="/Community/Events-Meetups.html">Events and Meetups</a></li>
                  
                  <li class=""><a href="/Community/Issues.html">Track issues</a></li>
                  
                  <li class=""><a href="/Community/JStormUsers.html">JStorm User List</a></li>
                  
              </ul>
            </li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Language <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li class=""><a href="/index.html">English</a></li>
                  <li class=""><a href="/index_cn.html">中文</a></li>

              </ul>
            </li>
          </ul>          
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<div class="row">

  
  
  <div class="col-md-8 col-md-offset-2 text">
    <h1>How to debug local topology?</h1>
	<ul id="markdown-toc">
  <li><a href="#如何本地调试-jstorm-程序" id="markdown-toc-如何本地调试-jstorm-程序">如何本地调试 JStorm 程序？</a>    <ul>
      <li><a href="#单机模式主要是在代码中加入" id="markdown-toc-单机模式主要是在代码中加入">单机模式主要是在代码中加入：</a></li>
      <li><a href="#修改pomxml" id="markdown-toc-修改pomxml">修改pom.xml</a></li>
      <li><a href="#运行main-class" id="markdown-toc-运行main-class">运行main class。</a></li>
      <li><a href="#注意点" id="markdown-toc-注意点">注意点</a></li>
      <li><a href="#常见问题" id="markdown-toc-常见问题">常见问题：</a>        <ul>
          <li><a href="#控制台没有任何输出" id="markdown-toc-控制台没有任何输出">控制台没有任何输出</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h1 id="如何本地调试-jstorm-程序">如何本地调试 JStorm 程序？</h1>

<p>JStorm 提供了两种运行模式：本地模式和分布式模式。本地模式针对开发调试storm topologies非常有用。</p>

<p>如果你还在用日常的web ui提交拓扑这种远古的方式进行调试测试，那就赶快阅读本文吧。本文将介绍在本机不安装JStorm环境的情况下，开发、调试JStorm程序。</p>

<h2 id="单机模式主要是在代码中加入">单机模式主要是在代码中加入：</h2>

<pre><code>```java
import backtype.storm.LocalCluster;

LocalCluster cluster = new LocalCluster();

//建议加上这行，使得每个bolt/spout的并发度都为1
conf.put(Config.TOPOLOGY_MAX_TASK_PARALLELISM, 1);

//提交拓扑
cluster.submitTopology("SequenceTest", conf, builder.createTopology());

//等待1分钟， 1分钟后会停止拓扑和集群， 视调试情况可增大该数值
Thread.sleep(60000);		
		
//结束拓扑
cluster.killTopology("SequenceTest");

cluster.shutdown();
```
用LocalCluster来模拟集群环境，你可以在`LocalCluster`对象上调用`submitTopology`方法来提交拓扑，`submitTopology(String topologyName, Map conf, StormTopology topology)`接受一个拓扑名称，一个拓扑的配置，以及一个拓扑的对象。就像`StormSubmitter`一样。你还可以调用`killTopology`来结束一个拓扑。对应的还有`active`,`deactive`,`rebalance`等方法。由于JStorm是个不会停止的程序，所以我们最后需要显示地停掉集群。
</code></pre>

<h2 id="修改pomxml">修改pom.xml</h2>

<pre><code>以jstorm 2.2.0版本为例。

```xml
&lt;dependency&gt;
  &lt;groupId&gt;com.alibaba.jstorm&lt;/groupId&gt;
  &lt;artifactId&gt;jstorm-core&lt;/artifactId&gt;
  &lt;version&gt;2.2.1&lt;/version&gt;
  &lt;!-- keep jstorm out of the jar-with-dependencies --&gt;
  &lt;!-- &lt;scope&gt;provided&lt;/scope&gt; --&gt;
&lt;/dependency&gt;
```

注意要注释掉jstorm依赖中的`&lt;scope&gt;provided&lt;/scope&gt;`，**而提交的时候必须记得将这行改回来！** 否则会报多个`defaults.yaml`的错误。(有的IDE 使用`&lt;scope&gt;provided&lt;/scope&gt;` 是可以支持本地模式， 有的IDE 不支持， 为了安全，可以先注释掉)

*注：如果依赖的是 0.9.x 版本的jstorm，会有三个依赖包，将这三个依赖的provided都注释掉。*
</code></pre>

<h2 id="运行main-class">运行main class。</h2>

<pre><code>运行后的截图如下： ![image](/img/programguide/localdebug.jpg)

为了更好的代码组织，建议将本地运行和集群运行写成两个方法，根据参数/配置来调用不同的运行方式。更多可以参照[SequenceTopology的例子](https://github.com/alibaba/jstorm/blob/master/example/sequence-split-merge/src/main/java/com/alipay/dw/jstorm/example/sequence/SequenceTopology.java)
</code></pre>

<h2 id="注意点">注意点</h2>

<pre><code>本地调试主要是用于测试应用逻辑的，因此有一些限制，如classloader是不起作用的。此外，还需要注意一下你的应用中log4j的依赖，如果应用的依赖中自带了log4j.properties，则有可能导致将jstorm默认的本地测试的log4j配置覆盖掉，从而导致调试时控制台没有任何输出。
</code></pre>

<h2 id="常见问题">常见问题：</h2>

<h3 id="控制台没有任何输出">控制台没有任何输出</h3>
<p>有几个原因可能导致这个问题：</p>

<pre><code>1.如果在2.2.0中依赖了slf4j-log4j12，会跟jstorm自带的log4j-over-slf4j冲突，需要将slf4j-log4j12排除掉。

2.确认你打的日志是用slf4j-api打的，即LoggerFactory而不是log4j的Logger
</code></pre>

  <div class="footer">
      Google Groups: <a target="_blank" href="https://groups.google.com/forum/#!forum/jstorm-user">jstorm-user</a>, QQ Groups: 228374502
      </p>
 
      发现错误？想参与编辑？
      <a href="https://github.com/alibaba/jstorm/edit/master/docs/jstorm-doc/ProgrammingGuide_cn/DebugLocalApp.md" target="_blank">
        在 Github 上编辑此页！
      </a>
  </div>
  </div>
  

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/js/jstorm.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    <!--
     -->
  </body>
</html>
